# 更新日志

## 版本 1.1.0 - 智能定位优化

### 🎯 主要改进

#### 1. 智能工具提示定位
- **问题**：工具提示在屏幕边缘时容易被遮挡
- **解决方案**：实现智能定位算法
  - 水平定位：优先右侧 → 左侧 → 居中
  - 垂直定位：优先上方 → 下方 → 居中
  - 自动检测视窗边界，确保工具提示完全可见

#### 2. 重复工具提示修复
- **问题**：在某些页面出现两个工具提示同时显示
- **解决方案**：
  - 实现单例模式，防止重复初始化
  - 添加全局实例检查
  - 在测试页面中添加扩展控制开关

#### 3. 网络连接优化
- **问题**：HTTPS页面无法访问HTTP API
- **解决方案**：
  - 实现双API策略：优先HTTPS (ipapi.co) → 备用HTTP (ip-api.com)
  - 更新manifest.json添加HTTPS权限
  - 改进错误处理和用户提示

### 🔧 技术改进

#### 定位算法
```javascript
// 智能定位逻辑
if (右侧有足够空间) → 显示在鼠标右侧
else if (左侧有足够空间) → 显示在鼠标左侧  
else → 居中显示

if (上方有足够空间) → 显示在鼠标上方
else if (下方有足够空间) → 显示在鼠标下方
else → 居中显示
```

#### 单例模式
```javascript
// 防止重复初始化
if (window.ipLocatorInstance) {
  return window.ipLocatorInstance;
}
window.ipLocatorInstance = this;
```

#### 双API支持
```javascript
// 优先HTTPS，备用HTTP
try {
  const response = await fetch(`https://ipapi.co/${ip}/json/`);
  // 处理HTTPS响应
} catch (e) {
  const response = await fetch(`http://ip-api.com/json/${ip}?fields=...`);
  // 处理HTTP响应
}
```

### 📁 新增文件

- `position-test.html` - 专门测试工具提示定位的页面
- `simple-test.html` - 简单测试页面，监控工具提示状态
- `CHANGELOG.md` - 更新日志文档

### 🧪 测试功能

#### 定位测试
- 打开 `position-test.html` 测试各种边缘位置的定位效果
- 使用切换按钮在扩展工具提示和页面内工具提示之间切换
- 观察工具提示的智能定位行为

#### 状态监控
- 打开 `simple-test.html` 查看工具提示状态
- 实时监控是否有重复工具提示
- 验证单例模式是否正常工作

### 🐛 修复的问题

1. **工具提示被遮挡** ✅
   - 实现智能定位算法
   - 自动调整工具提示位置

2. **重复工具提示** ✅
   - 添加单例模式
   - 防止重复初始化

3. **网络连接错误** ✅
   - 实现双API策略
   - 改进错误处理

4. **性能问题** ✅
   - 移除自动页面扫描
   - 改为悬停触发模式

### 📈 性能优化

- 移除MutationObserver，避免无限循环
- 使用事件委托，减少事件监听器数量
- 实现智能缓存，避免重复API调用
- 优化DOM操作，减少页面重绘

### 🔮 未来计划

- [ ] 支持IPv6地址检测
- [ ] 添加更多地理位置API选项
- [ ] 实现用户自定义配置
- [ ] 添加历史记录功能
- [ ] 支持批量IP查询

---

## 版本 1.0.0 - 初始版本

### 🎉 首次发布

- 基本的IP地址检测功能
- 地理位置查询和显示
- Chrome扩展框架
- 简单的用户界面

---

*最后更新：2024年* 